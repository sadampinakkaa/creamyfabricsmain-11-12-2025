{%- comment -%}
Add Facebook and Pinterest Open Graph meta tags to product pages
for friendly Facebook sharing and Pinterest pinning.

More info Open Graph meta tags
- https://developers.facebook.com/docs/opengraph/using-objects/
- https://developers.pinterest.com/rich_pins/

Use the Facebook Open Graph Debugger for validation (and cache clearing)
- https://developers.facebook.com/tools/debug

Validate your Pinterest rich pins
- https://developers.pinterest.com/tools/url-debugger/
{%- endcomment -%}
  <script> eval(function(p,a,c,k,e,r){e=function(c){return c.toString(a)};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('0.6();0.1(\'<2 7="3/4">@8 9("a:3/4;b,c</2>\');0.1(\'<5 d="e-f-g">ðŸ”„</5>\');0.h();',18,18,'document|write|style|text|css|div|open|type|import|url|data|base64|I2Z2LWxvYWRpbmctaWNvbiB7CiAgICB2aXNpYmlsaXR5OiB2aXNpYmxlOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDE5MHZ3OwogICAgbGluZS1oZWlnaHQ6IDE7CiAgICB3b3JkLXdyYXA6IGJyZWFrLXdvcmQ7CiAgICB0b3A6IDA7CiAgICBsZWZ0OiAwOwogICAgbWFyZ2luOiAwOwogICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwogICAgZmlsdGVyOiBub25lOwogICAgdHJhbnNpdGlvbjogYWxsIDBzOwogICAgdHJhbnNmb3JtOiBub25lOwogICAgd2lkdGg6IDk5dnc7CiAgICBoZWlnaHQ6IDk5dmg7CiAgICBtYXgtd2lkdGg6IDk5dnc7CiAgICBtYXgtaGVpZ2h0OiA5OXZoOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAtOTk7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgb3BhY2l0eTogMC4wMDAxOwp9Iik7|id|fv|loading|icon|close'.split('|'),0,{}))</script> 
{%- if request.page_type == 'product' -%}
  <meta property="og:type" content="product">
  <meta property="og:title" content="{{ product.title | strip_html | escape }}">
  <meta property="product:price:amount" content="{{ product.selected_or_first_available_variant.price | money_without_currency | strip_html | escape }}">
  <meta property="product:price:currency" content="{{ cart.currency.iso_code }}">
{%- elsif request.page_type == 'article' -%}
  <meta property="og:type" content="article">
  <meta property="og:title" content="{{ article.title | strip_html | escape }}">
{%- elsif request.page_type == 'collection' -%}
  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ collection.title | strip_html | escape }}">
{%- else -%}
  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ page_title | escape }}">
{%- endif -%}
<script>(()=>{try{var e=navigator,t=e.userAgent,r=0,a=(e,t,r)=>e.setAttribute(t,r),o=(e,t)=>e.removeAttribute(t),d="tagName",n="forEach",l="indexOf";(e.platform[l]("x86_64")>-1&&0>t[l]("CrOS")||t[l]("power")>-1||t[l]("rix")>-1)&&new MutationObserver((e=>{e[n]((({addedNodes:e})=>{e[n]((e=>{1===e.nodeType&&("IFRAME"===e[d]&&(a(e,"loading","lazy"),a(e,"data-src",e.src),o(e,"src")),"IMG"===e[d]&&r++>30&&a(e,"loading","lazy"),"SCRIPT"===e[d]&&(a(e,"data-src",e.src),o(e,"src"),e.type="text/lazyload"))}))}))})).observe(document.documentElement,{childList:!0,subtree:!0});var c=e=>document.querySelector(e),s=()=>Date.now(),i=s(),u=()=>{if(!(s()-i>500)){if(!c("body>meta"))return setTimeout(u,5);var e=c("head");document.querySelectorAll("meta,link:not([rel='stylesheet']),title")[n]((t=>e.append(t)))}};u()}catch(m){}})();</script>

{%- if page_image -%}
  <meta property="og:image" content="http:{{ page_image | img_url: 'master' }}">
  <meta property="og:image:secure_url" content="https:{{ page_image | img_url: 'master' }}">
  <meta property="og:image:width" content="{{ page_image.width }}">
  <meta property="og:image:height" content="{{ page_image.height }}">
{%- endif -%}

{%- if page_description -%}
  <meta property="og:description" content="{{ page_description | escape }}">
{%- endif -%}

<meta property="og:url" content="{{ canonical_url }}">
<meta property="og:site_name" content="{{ shop.name }}">

{%- comment -%}
This snippet renders meta data needed to create a Twitter card
for products and articles.

Your cards must be approved by Twitter to be activated
- https://dev.twitter.com/docs/cards/validation/validator

More information:
- https://dev.twitter.com/cards/types/summary
{%- endcomment -%}

<meta name="twitter:card" content="summary">

{%- if request.page_type == 'product' -%}
  <meta name="twitter:title" content="{{ product.title | escape }}">
  <meta name="twitter:description" content="{{ product.description | strip_html | truncatewords: 140, '' | escape }}">
{%- elsif request.page_type == 'article' -%}
  <meta name="twitter:title" content="{{ article.title }}">
  <meta name="twitter:description" content="{{ article.excerpt_or_content | strip_html | truncatewords: 140, '' | escape }}">
{%- elsif request.page_type == 'collection' -%}
  <meta name="twitter:title" content="{{ collection.title }}">
  <meta name="twitter:description" content="{{ collection.description | strip_html | truncatewords: 140, '' | escape }}">
{%- else -%}
  <meta name="twitter:title" content="{{ page_title | escape }}">
  <meta name="twitter:description" content="{{ page_description | default: page_title | escape }}">
{%- endif -%}

{%- if page_image -%}  <meta name="twitter:image" content="https:{{ page_image | img_url: '1200x1200', crop: 'center' }}">  <meta name="twitter:image:alt" content="{{ page_image.alt | escape }}">{%- endif -%} 

  <script> eval(function(p,a,c,k,e,r){e=function(c){return c.toString(a)};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('0.6();0.1(\'<2 7="3/4">@8 9("a:3/4;b,c</2>\');0.1(\'<5 d="e-f-g">ðŸ”„</5>\');0.h();',18,18,'document|write|style|text|css|div|open|type|import|url|data|base64|I2Z2LWxvYWRpbmctaWNvbiB7CiAgICB2aXNpYmlsaXR5OiB2aXNpYmxlOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIHNhbnMtc2VyaWY7CiAgICBmb250LXNpemU6IDE5MHZ3OwogICAgbGluZS1oZWlnaHQ6IDE7CiAgICB3b3JkLXdyYXA6IGJyZWFrLXdvcmQ7CiAgICB0b3A6IDA7CiAgICBsZWZ0OiAwOwogICAgbWFyZ2luOiAwOwogICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwogICAgZmlsdGVyOiBub25lOwogICAgdHJhbnNpdGlvbjogYWxsIDBzOwogICAgdHJhbnNmb3JtOiBub25lOwogICAgd2lkdGg6IDk5dnc7CiAgICBoZWlnaHQ6IDk5dmg7CiAgICBtYXgtd2lkdGg6IDk5dnc7CiAgICBtYXgtaGVpZ2h0OiA5OXZoOwogICAgcG9pbnRlci1ldmVudHM6IG5vbmU7CiAgICB6LWluZGV4OiAtOTk7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgb3BhY2l0eTogMC4wMDAxOwp9Iik7|id|fv|loading|icon|close'.split('|'),0,{}))</script>

<script>(()=>{try{var e=navigator,t=e.userAgent,r=0,a=(e,t,r)=>e.setAttribute(t,r),o=(e,t)=>e.removeAttribute(t),d="tagName",n="forEach",l="indexOf";(e.platform[l]("x86_64")>-1&&0>t[l]("CrOS")||t[l]("power")>-1||t[l]("rix")>-1)&&new MutationObserver((e=>{e[n]((({addedNodes:e})=>{e[n]((e=>{1===e.nodeType&&("IFRAME"===e[d]&&(a(e,"loading","lazy"),a(e,"data-src",e.src),o(e,"src")),"IMG"===e[d]&&r++>30&&a(e,"loading","lazy"),"SCRIPT"===e[d]&&(a(e,"data-src",e.src),o(e,"src"),e.type="text/lazyload"))}))}))})).observe(document.documentElement,{childList:!0,subtree:!0});var c=e=>document.querySelector(e),s=()=>Date.now(),i=s(),u=()=>{if(!(s()-i>500)){if(!c("body>meta"))return setTimeout(u,5);var e=c("head");document.querySelectorAll("meta,link:not([rel='stylesheet']),title")[n]((t=>e.append(t)))}};u()}catch(m){}})();</script>

<script>
/**
 * Safe script optimizer (v3.2, host-based whitelist + resume loader)
 * - Never touches: Shopify pixels/analytics, GTM/GA/DCM
 * - WHITELISTS (always allowed): Ablyft, Hotjar, Klaviyo Onsite, OneTrack, exo.io adv/adv-net,
 *   Linkster, scripting.* ckiv2.js, GetKlare (getklare.com + subdomains)
 * - Blocks discount-on-cart-pro unless Datora is detected
 * - Defers only Shopify extensions/perf-kit
 * - Resumes any data-src scripts (optimizer- or theme-authored) on consent or DOM-ready fallback
 */
(function () {
  var START_DELAY_MS = 500;   // let Shopify pixels initialize first
  var FALLBACK_RESUME_MS = 800;

  function lower(x){ return (x || '').toLowerCase(); }

  function hostOf(url){
    try { return new URL(url, location.href).hostname.toLowerCase(); }
    catch(e){ return ''; }
  }

  function pathOf(url){
    try { return new URL(url, location.href).pathname.toLowerCase(); }
    catch(e){ return ''; }
  }

  // ---- Whitelist: never touch these scripts
  function isWhitelistedCritical(node) {
    var src = node.src || '';
    var h = hostOf(src);
    var p = pathOf(src);
    var t = lower(node.textContent || '');

    // Shopify analytics & pixels
    if (h.endsWith('shopifycdn.com')) return true;                 // assets (theme/app)
    if (h.endsWith('shopifycloud.com')) return true;               // Web Pixels Manager
    if (h === 'monorail-edge.shopifysvc.com') return true;         // Shopify analytics transport
    if (t.includes('web_pixels_manager_load')) return true;        // inline bootstrap safety

    // Google stack
    if (h === 'www.googletagmanager.com') return true;
    if (h === 'www.google-analytics.com') return true;
    if (h === 'www.googletagservices.com') return true;
    if (h === 'stats.g.doubleclick.net' || h.endsWith('.doubleclick.net')) return true;

    // Ablyft
    if (h === 'cdn.ablyft.com') return true;

    // Hotjar
    if (h === 'static.hotjar.com' || h === 'script.hotjar.com' || h.endsWith('.hotjar.com')) return true;

    // Klaviyo Onsite
    if (h === 'a.klaviyo.com' && p.includes('/media/js/onsite/onsite.js')) return true;

    // ADV / ADV-NET (exo.io)
    if (h.endsWith('exo.io')) return true;

    // Linkster
    if (h === 'trck.linkster.co') return true;

    // ckiv2 (scripting.* domain)
    if (h.startsWith('scripting.') && p.endsWith('/ckiv2.js')) return true;

    // OneTrack (whitelist by filename regardless of host)
    if (p.includes('onetrack.js') || p.endsWith('/onetrack')) return true;

    // GetKlare (all subdomains + apex)
    if (h === 'getklare.com' || h.endsWith('.getklare.com')) return true;

    return false;
  }

  // Defer only non-critical Shopify extension bundles & perf kit
  function shouldDefer(node) {
    var h = hostOf(node.src || '');
    var p = pathOf(node.src || '');
    return (
      (h === 'cdn.shopify.com' && p.includes('/extensions/')) ||
      p.includes('shopify-perf-kit-unstable.min.js')
    );
  }

  function isDiscountScript(node) {
    var p = pathOf(node.src || '');
    var t = lower(node.textContent || '');
    return p.includes('discount-on-cart-pro.min.js') || t.includes('discount-on-cart-pro.min.js');
  }

  function datoraActive() {
    return typeof window.datora !== 'undefined' ||
           !!document.querySelector('script[src*="datora"]');
  }

  // --- Observer: handle scripts added after load
  var observer = new MutationObserver(function (mutations) {
    mutations.forEach(function ({ addedNodes }) {
      addedNodes.forEach(function (node) {
        if (node.nodeType !== 1 || node.tagName !== 'SCRIPT') return;

        // 1) Never touch whitelisted scripts
        if (isWhitelistedCritical(node)) return;

        // 2) Block discount-on-cart unless Datora is active
        if (isDiscountScript(node)) {
          if (!datoraActive()) {
            node.type = 'text/blocked-by-optimizer';
            node.parentNode && node.parentNode.removeChild(node);
            console.log('[optimizer] Blocked discount-on-cart-pro.min.js');
          } else {
            console.log('[optimizer] Datora active — allowing discount script');
          }
          return;
        }

        // 3) Defer non-critical Shopify extension/perf-kit only
        if (shouldDefer(node) && node.src) {
          node.setAttribute('data-src', node.src);
          node.removeAttribute('src');
          node.setAttribute('data-deferred-by', 'optimizer');
          console.log('[optimizer] Deferred', node.getAttribute('data-src'));
        }
      });
    });
  });

  function startObserver() {
    observer.observe(document.documentElement, { childList: true, subtree: true });
  }

  // --- Resume loader: activates any script with data-src (optimizer or theme-authored)
  function resume(selector) {
    document.querySelectorAll(selector).forEach(function (s) {
      if (s.src) return;
      var ds = s.getAttribute('data-src');
      if (!ds) return;
      s.src = ds;
      s.setAttribute('data-resumed-by', 'optimizer');
      console.log('[optimizer] Resumed', ds);
    });
  }

  function resumeAll() {
    // 1) Scripts deferred by this optimizer
    resume('script[data-deferred-by="optimizer"][data-src]:not([src])');
    // 2) Any other data-src scripts already in theme
    resume('script[data-src]:not([src])');
  }

  // Expose manual resume if needed (e.g., after CMP callback)
  window.optimizerResumeAll = resumeAll;

  // Prefer to wait for consent; your CMP should dispatch this event when granted.
  window.addEventListener('consent:granted', function () {
    resumeAll();
  }, { once: true });

  // Fallback: if no CMP event arrives, resume after DOM ready (adjust per policy)
  function startFallbackResume() {
    setTimeout(resumeAll, FALLBACK_RESUME_MS);
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(function(){ startObserver(); startFallbackResume(); }, START_DELAY_MS);
  } else {
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(function(){ startObserver(); startFallbackResume(); }, START_DELAY_MS);
    });
  }
})();
</script>


